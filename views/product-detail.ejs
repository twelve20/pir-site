<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.title %> - Планета PIR</title>
    <meta name="description" content="<%= product.description %>">

    <!-- Open Graph -->
    <meta property="og:title" content="<%= product.title %>">
    <meta property="og:description" content="<%= product.description %>">
    <meta property="og:image" content="https://pir-planet.ru<%= product.image %>">
    <meta property="og:type" content="product">

    <!-- Schema.org разметка для товара -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "<%= product.title %>",
      "image": "https://pir-planet.ru<%= product.image %>",
      "description": "<%= product.description %>",
      "sku": "<%= product.id %>",
      "brand": {
        "@type": "Brand",
        "name": "Планета PIR"
      },
      "offers": {
        "@type": "Offer",
        "url": "https://pir-planet.ru/product/<%= product.id %>",
        "priceCurrency": "RUB",
        "price": "<%= product.price %>",
        <% if (product.oldPrice) { %>
        "priceValidUntil": "2025-12-31",
        <% } %>
        "availability": "<%= product.inStock ? 'https://schema.org/InStock' : 'https://schema.org/OutOfStock' %>",
        "seller": {
          "@type": "Organization",
          "name": "Планета PIR"
        }
      }
    }
    </script>

    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <%- include('partials/header') %>

    <main class="product-detail-page">
        <div class="container">
            <!-- Хлебные крошки -->
            <nav class="breadcrumbs">
                <a href="/">Главная</a>
                <span>/</span>
                <a href="/#mini-catalog">Каталог</a>
                <span>/</span>
                <span><%= product.title %></span>
            </nav>

            <div class="product-detail-grid">
                <!-- Левая колонка - Изображение -->
                <div class="product-image-section">
                    <div class="main-image">
                        <img src="<%= product.image %>" alt="<%= product.title %>" id="mainProductImage">
                        <% if (product.isPromo) { %>
                            <div class="promo-badge">Акция!</div>
                        <% } %>
                        <% if (!product.inStock) { %>
                            <div class="out-of-stock-badge">Нет в наличии</div>
                        <% } %>
                    </div>

                    <!-- Можно добавить мини-галерею позже -->
                    <!-- <div class="image-thumbnails">
                        <img src="<%= product.image %>" alt="Миниатюра 1" class="thumbnail active">
                    </div> -->
                </div>

                <!-- Правая колонка - Информация о товаре -->
                <div class="product-info-section">
                    <h1 class="product-title"><%= product.title %></h1>

                    <div class="product-meta">
                        <span class="product-id">Артикул: <%= product.id %></span>
                        <% if (product.inStock) { %>
                            <span class="in-stock"><i class="fas fa-check-circle"></i> В наличии</span>
                        <% } else { %>
                            <span class="out-of-stock"><i class="fas fa-times-circle"></i> Нет в наличии</span>
                        <% } %>
                    </div>

                    <p class="product-description"><%= product.description %></p>

                    <!-- Цена -->
                    <div class="price-block">
                        <% if (product.isPromo && product.oldPrice) { %>
                            <div class="price-promo">
                                <span class="old-price"><%= typeof product.oldPrice === 'number' ? product.oldPrice + ' руб./шт.' : product.oldPrice %></span>
                                <% if (product.discountPercent) { %>
                                    <span class="discount-badge">-<%= product.discountPercent %>%</span>
                                <% } %>
                            </div>
                            <div class="current-price"><%= typeof product.price === 'number' ? product.price + ' руб./шт.' : product.price %></div>
                            <% if (product.savings) { %>
                                <div class="savings-text">Экономия: <%= product.savings %> руб.</div>
                            <% } %>
                        <% } else { %>
                            <div class="current-price"><%= typeof product.price === 'number' ? product.price + ' руб./шт.' : product.price %></div>
                        <% } %>
                        <% if (product.pricePerSquareMeter) { %>
                            <div class="price-per-m2">
                                Цена за м²: <%= product.pricePerSquareMeter %> руб./м²
                            </div>
                        <% } %>
                    </div>

                    <!-- Технические характеристики -->
                    <div class="product-specs">
                        <h3>Технические характеристики</h3>
                        <table class="specs-table">
                            <% if (product.thickness) { %>
                            <tr>
                                <td>Толщина</td>
                                <td><strong><%= product.thickness %> мм</strong></td>
                            </tr>
                            <% } %>
                            <% if (product.area) { %>
                            <tr>
                                <td>Площадь плиты</td>
                                <td><strong><%= product.area %> м²</strong></td>
                            </tr>
                            <% } %>
                            <% if (product.material) { %>
                            <tr>
                                <td>Материал покрытия</td>
                                <td><strong><%= product.material === 'foil' ? 'Фольга' : 'Крафт-бумага' %></strong></td>
                            </tr>
                            <% } %>
                            <% if (product.packQuantity) { %>
                            <tr>
                                <td>В упаковке</td>
                                <td><strong><%= product.packQuantity %> шт.</strong></td>
                            </tr>
                            <% } %>
                            <% if (product.packArea) { %>
                            <tr>
                                <td>Площадь упаковки</td>
                                <td><strong><%= product.packArea %> м²</strong></td>
                            </tr>
                            <% } %>
                            <% if (product.application) { %>
                            <tr>
                                <td>Применение</td>
                                <td><strong><%= product.application %></strong></td>
                            </tr>
                            <% } %>
                            <% if (product.coverage) { %>
                            <tr>
                                <td>Расход</td>
                                <td><strong>1 баллон на <%= product.coverage %> м²</strong></td>
                            </tr>
                            <% } %>
                        </table>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="product-actions">
                        <% if (product.inStock) { %>
                            <button class="btn-add-to-cart" onclick="addToCart('<%= product.id %>')" data-product-id="<%= product.id %>">
                                <i class="fas fa-shopping-cart"></i>
                                Добавить в корзину
                            </button>
                        <% } else { %>
                            <button class="btn-notify" onclick="openCallModal()">
                                <i class="fas fa-bell"></i>
                                Уведомить о поступлении
                            </button>
                        <% } %>

                        <button class="btn-calculator" onclick="openCalculatorModal('<%= product.id %>')">
                            <i class="fas fa-calculator"></i>
                            Рассчитать количество
                        </button>

                        <button class="btn-call" onclick="openCallModal()">
                            <i class="fas fa-phone"></i>
                            Заказать звонок
                        </button>
                    </div>

                    <!-- Преимущества -->
                    <div class="product-benefits">
                        <div class="benefit">
                            <i class="fas fa-truck"></i>
                            <span>Быстрая доставка</span>
                        </div>
                        <div class="benefit">
                            <i class="fas fa-shield-alt"></i>
                            <span>Гарантия качества</span>
                        </div>
                        <div class="benefit">
                            <i class="fas fa-headset"></i>
                            <span>Консультация специалиста</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Подробное описание -->
            <div class="product-details-tabs">
                <div class="tabs-header">
                    <button class="tab-btn active" data-tab="description">Описание</button>
                    <button class="tab-btn" data-tab="specs">Характеристики</button>
                    <button class="tab-btn" data-tab="delivery">Доставка</button>
                </div>

                <div class="tabs-content">
                    <div class="tab-pane active" id="description">
                        <h3>Описание товара</h3>
                        <p><%= product.description %></p>
                        <% if (product.application) { %>
                            <h4>Применение</h4>
                            <p><%= product.application %></p>
                        <% } %>
                        <h4>Преимущества PIR плит</h4>
                        <ul>
                            <li>Высокая теплоизоляция</li>
                            <li>Влагостойкость</li>
                            <li>Долговечность более 50 лет</li>
                            <li>Экологичность</li>
                            <li>Простота монтажа</li>
                        </ul>
                    </div>

                    <div class="tab-pane" id="specs">
                        <h3>Полные характеристики</h3>
                        <table class="full-specs-table">
                            <% if (product.thickness) { %>
                            <tr>
                                <td>Толщина</td>
                                <td><%= product.thickness %> мм</td>
                            </tr>
                            <% } %>
                            <% if (product.area) { %>
                            <tr>
                                <td>Площадь плиты</td>
                                <td><%= product.area %> м²</td>
                            </tr>
                            <% } %>
                            <% if (product.material) { %>
                            <tr>
                                <td>Материал покрытия</td>
                                <td><%= product.material === 'foil' ? 'Алюминиевая фольга' : 'Крафт-бумага' %></td>
                            </tr>
                            <% } %>
                            <% if (product.packQuantity) { %>
                            <tr>
                                <td>Количество в упаковке</td>
                                <td><%= product.packQuantity %> шт.</td>
                            </tr>
                            <% } %>
                            <% if (product.packArea) { %>
                            <tr>
                                <td>Площадь упаковки</td>
                                <td><%= product.packArea %> м²</td>
                            </tr>
                            <% } %>
                            <tr>
                                <td>Коэффициент теплопроводности</td>
                                <td>0.021 Вт/(м·K)</td>
                            </tr>
                            <tr>
                                <td>Плотность</td>
                                <td>30-35 кг/м³</td>
                            </tr>
                            <tr>
                                <td>Температура эксплуатации</td>
                                <td>от -70°C до +110°C</td>
                            </tr>
                        </table>
                    </div>

                    <div class="tab-pane" id="delivery">
                        <h3>Доставка и оплата</h3>
                        <h4>Доставка</h4>
                        <p>Мы осуществляем доставку по Москве и Московской области.</p>
                        <ul>
                            <li>Доставка по Москве (в пределах МКАД) - бесплатно при заказе от 50 000 руб.</li>
                            <li>Доставка за МКАД - рассчитывается индивидуально</li>
                            <li>Самовывоз со склада - бесплатно</li>
                        </ul>

                        <h4>Оплата</h4>
                        <ul>
                            <li>Наличными при получении</li>
                            <li>Банковской картой</li>
                            <li>Безналичный расчет для юридических лиц</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Похожие товары -->
            <% if (similarProducts && similarProducts.length > 0) { %>
                <%- include('partials/similar-products', { products: similarProducts }) %>
            <% } %>
        </div>
    </main>

    <%- include('partials/footer') %>

    <!-- Модальное окно калькулятора -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-modal">
            <span class="modal-close" onclick="closeCalculatorModal()">&times;</span>
            <div class="modal-header">
                <i class="fas fa-calculator calculator-icon"></i>
                <h2>Калькулятор материалов</h2>
                <p class="modal-subtitle">Рассчитайте необходимое количество материала для вашего проекта</p>
            </div>

            <div class="calculator-form">
                <div class="form-group-calc">
                    <label for="areaInput">
                        <i class="fas fa-ruler-combined"></i>
                        Площадь помещения (м²)
                    </label>
                    <input type="number" id="areaInput" min="1" step="0.1" placeholder="Например: 50" class="calc-input">
                    <span class="input-hint">Введите площадь в квадратных метрах</span>
                </div>

                <div id="calculationResult" class="calculation-result"></div>

                <button class="btn-calculate" onclick="calculateMaterials()">
                    <i class="fas fa-calculator"></i>
                    Рассчитать количество
                </button>
            </div>
        </div>
    </div>

    <script src="/js/script.js"></script>
    <script>
        // Текущий товар для калькулятора
        let currentProduct = <%- JSON.stringify(product) %>;

        // Функция добавления в корзину
        async function addToCart(productId) {
            const button = document.querySelector(`button[data-product-id="${productId}"]`);

            if (button.classList.contains('loading')) return;

            button.classList.add('loading');
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Добавление...';

            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, quantity: 1 })
                });

                const result = await response.json();

                if (response.ok) {
                    button.classList.remove('loading');
                    button.classList.add('added');
                    button.innerHTML = '<i class="fas fa-check"></i> Добавлено в корзину';

                    if (typeof updateCartBadge === 'function') {
                        updateCartBadge(result.cart.count);
                    }

                    setTimeout(() => {
                        button.classList.remove('added');
                        button.innerHTML = originalContent;
                    }, 2000);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                button.classList.remove('loading');
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ошибка';

                setTimeout(() => {
                    button.innerHTML = originalContent;
                }, 2000);
            }
        }

        // Табы
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

                this.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Открыть модальное окно калькулятора
        function openCalculatorModal(productId) {
            const modal = document.getElementById('calculatorModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            // Анимация появления
            setTimeout(() => {
                modal.classList.add('modal-show');
            }, 10);
        }

        function closeCalculatorModal() {
            const modal = document.getElementById('calculatorModal');
            modal.classList.remove('modal-show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                // Очистка формы
                document.getElementById('areaInput').value = '';
                document.getElementById('calculationResult').innerHTML = '';
            }, 300);
        }

        // Рассчитать материалы
        function calculateMaterials() {
            const areaInput = document.getElementById('areaInput');
            const area = parseFloat(areaInput.value);

            if (!area || area <= 0) {
                areaInput.classList.add('error-shake');
                setTimeout(() => areaInput.classList.remove('error-shake'), 500);
                showError('Пожалуйста, введите корректную площадь');
                return;
            }

            const productArea = currentProduct.area || 0.72;
            const quantity = Math.ceil(area / productArea);
            const totalArea = (quantity * productArea).toFixed(2);
            const totalPrice = quantity * currentProduct.price;
            const savings = totalArea - area;
            const pricePerM2 = (totalPrice / totalArea).toFixed(2);

            const resultHTML = `
                <div class="result-header">
                    <i class="fas fa-check-circle success-icon"></i>
                    <h4>Результат расчёта</h4>
                </div>

                <div class="result-main">
                    <div class="result-item highlight">
                        <div class="result-label">
                            <i class="fas fa-layer-group"></i>
                            Необходимое количество
                        </div>
                        <div class="result-value">${quantity} шт.</div>
                    </div>

                    <div class="result-item">
                        <div class="result-label">
                            <i class="fas fa-ruler-combined"></i>
                            Ваша площадь
                        </div>
                        <div class="result-value">${area} м²</div>
                    </div>

                    <div class="result-item">
                        <div class="result-label">
                            <i class="fas fa-expand-arrows-alt"></i>
                            Общая площадь материала
                        </div>
                        <div class="result-value">${totalArea} м²</div>
                    </div>

                    ${savings > 0 ? `
                    <div class="result-item info">
                        <div class="result-label">
                            <i class="fas fa-info-circle"></i>
                            Запас материала
                        </div>
                        <div class="result-value">${savings.toFixed(2)} м²</div>
                    </div>
                    ` : ''}
                </div>

                <div class="result-footer">
                    <div class="price-breakdown">
                        <div class="price-item">
                            <span>Цена за м²:</span>
                            <span>${pricePerM2} руб.</span>
                        </div>
                        <div class="price-total">
                            <span>Итоговая стоимость:</span>
                            <span class="total-amount">${totalPrice.toLocaleString('ru-RU')} руб.</span>
                        </div>
                    </div>

                    <button class="btn-order-calc" onclick="openCallModal()">
                        <i class="fas fa-phone"></i>
                        Оформить заказ
                    </button>
                </div>
            `;

            const resultDiv = document.getElementById('calculationResult');
            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';
            resultDiv.classList.add('result-show');
        }

        function showError(message) {
            const resultDiv = document.getElementById('calculationResult');
            resultDiv.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${message}</p>
                </div>
            `;
            resultDiv.style.display = 'block';
            setTimeout(() => {
                resultDiv.innerHTML = '';
                resultDiv.style.display = 'none';
            }, 3000);
        }

        // Закрытие модального окна при клике вне его
        window.onclick = function(event) {
            const modal = document.getElementById('calculatorModal');
            if (event.target == modal) {
                closeCalculatorModal();
            }
        }
    </script>

    <style>
        <%- include('partials/product-detail-styles') %>
    </style>
</body>
</html>
