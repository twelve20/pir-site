let products={};let GLUE_PRICE=1050;let GLUE_COVERAGE=10;async function loadProductData(){try{const response=await fetch("/api/products");const data=await response.json();products=data.products;GLUE_PRICE=data.glue.price;GLUE_COVERAGE=data.glue.coverage}catch(error){console.error("Ошибка загрузки данных о продуктах:",error);products={"pir-foil-30":{price:510,oldPrice:535,name:"PIR плита для бани ФОЛЬГА 30 мм",isPromo:true,area:.72},"pirro-termo-30":{price:510,name:"PIR плита для бани ФОЛЬГА 30 мм",area:.72},"pirro-termo-40":{price:647,name:"PIR плита для бани ФОЛЬГА 40 мм",area:.72},"pirro-termo-50":{price:755,name:"PIR плита для бани ФОЛЬГА 50 мм",area:.72},"pir-foil-100":{price:5564,name:"PIR Плита ФОЛЬГА 100 мм",area:2.88},"pir-craft-30":{price:410,name:"PIR Плита КРАФТ БУМАГА 30 мм",area:.72},"pir-craft-40":{price:520,name:"PIR Плита КРАФТ БУМАГА 40 мм",area:.72},"pir-craft-50":{price:600,name:"PIR Плита КРАФТ БУМАГА 50 мм",area:.72}}}}document.addEventListener("DOMContentLoaded",async()=>{const calculator=document.getElementById("pir-calculator");if(!calculator)return;await loadProductData();const areaInput=calculator.querySelector("#calc-area");const typeSelect=calculator.querySelector("#calc-type");const glueCheckbox=calculator.querySelector("#calc-glue");const calculateBtn=calculator.querySelector("#calc-button");const resultDiv=calculator.querySelector("#calc-result");const commentField=document.querySelector(".cta__form textarea");const sendWithCalcBtn=calculator.querySelector("#send-with-calc");calculateBtn.addEventListener("click",()=>{const area=parseFloat(areaInput.value);if(!area||area<1){resultDiv.innerHTML='<p class="calc-error">Введите корректную площадь</p>';return}const selectedProduct=products[typeSelect.value];if(!selectedProduct){resultDiv.innerHTML='<p class="calc-error">Выбранный продукт не найден</p>';return}const platesCount=Math.ceil(area/selectedProduct.area);const platesPrice=platesCount*selectedProduct.price;let glueCount=0;let gluePrice=0;let totalPrice=platesPrice;if(glueCheckbox.checked){glueCount=Math.ceil(area/GLUE_COVERAGE);gluePrice=glueCount*GLUE_PRICE;totalPrice+=gluePrice}let promoMessage="";if(selectedProduct.isPromo){const savings=(selectedProduct.oldPrice-selectedProduct.price)*platesCount;promoMessage=`<p class="calc-result__promo">✨ Акционный товар! Экономия: ${savings} руб. ✨</p>`}const result=`\n            <div class="calc-result__content">\n                <p>Вам нужно:</p>\n                <p>${selectedProduct.name} — ${platesCount} плит, ${platesPrice} руб.</p>\n                ${glueCheckbox.checked?`<p>Клей-пена: ${glueCount} баллон(ов) — ${gluePrice} руб.</p>`:""}\n                <p class="calc-result__total">Итого: ${totalPrice} руб.</p>\n                ${promoMessage}\n            </div>\n        `;resultDiv.innerHTML=result;resultDiv.classList.add("show");sendWithCalcBtn.style.display="block";calculator.dataset.calculationResult=`${selectedProduct.name} — ${platesCount} плит, ${platesPrice} руб.`+(glueCheckbox.checked?`, клей-пена — ${glueCount} баллон(ов), ${gluePrice} руб.`:"")+`, итог ${totalPrice} руб.`});sendWithCalcBtn.addEventListener("click",()=>{if(calculator.dataset.calculationResult){commentField.value=calculator.dataset.calculationResult;commentField.closest("form").scrollIntoView({behavior:"smooth"})}})});